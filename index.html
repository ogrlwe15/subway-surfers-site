<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subway Surfers by Mynvo</title>
  <meta name="description" content="Subway Surfers version Mynvo avec TOP 3 et FPS">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Segoe UI,sans-serif;background:linear-gradient(135deg,#5e4fff,#8b5cf6);color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    header{background:rgba(0,0,0,0.35);backdrop-filter:blur(12px);padding:18px 40px;position:fixed;top:0;left:0;right:0;z-index:100;}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
    .logo{font-size:34px;font-weight:900;display:flex;align-items:center;gap:14px;}
    .logo img{height:50px;border-radius:50%;border:4px solid #ffd700;box-shadow:0 0 20px #ffd70044;}
    .logo span{color:#ffd700;}
    .nav-links a{color:#fff;text-decoration:none;margin-left:24px;font-weight:600;font-size:17px;transition:0.2s;cursor:pointer;}
    .nav-links a:hover{opacity:0.7;}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}
    .game-container{width:100%;max-width:1350px;background:rgba(0,0,0,0.4);backdrop-filter:blur(20px);border-radius:28px;padding:40px;box-shadow:0 25px 80px rgba(0,0,0,0.5);overflow:hidden;position:relative;}
    h1{font-size:56px;text-align:center;margin-bottom:30px;text-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .game-frame{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(0,0,0,0.6);}
    iframe{width:100%;height:720px;border:none;background:#000;display:block;}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;text-align:center;}
    .spinner{width:70px;height:70px;border:8px solid #ffffff33;border-top:8px solid #ffd700;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    footer{text-align:center;padding:25px;font-size:15px;opacity:0.85;background:rgba(0,0,0,0.2);}
    .fs-button{position:absolute;top:18px;right:18px;z-index:200;background:rgba(0,0,0,0.6);border:2px solid #ffd700;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .fs-button:hover{opacity:0.9;}
    .key-display{display:inline-block;min-width:50px;padding:10px 16px;background:#333;border:2px solid #555;border-radius:8px;text-align:center;font-weight:700;font-size:18px;cursor:pointer;transition:0.2s;}
    .key-display:hover{border-color:#ffd700;background:#444;}
    .key-display.active{border-color:#00ff00;background:#1a4d1a;animation:pulse 0.5s;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
    .key-display[data-key="jump"]{min-width:80px;}
    #fps-overlay{position:fixed;top:100px;left:20px;z-index:999999;background:rgba(0,0,0,0.85);color:#22c55e;padding:10px 18px;border-radius:12px;font-size:18px;font-weight:700;border:2px solid #22c55e;box-shadow:0 0 20px rgba(34,197,94,0.3);font-family:system-ui,sans-serif;pointer-events:none;}
    #top3-overlay{position:fixed;bottom:20px;left:20px;z-index:999999;background:rgba(0,0,0,0.9);color:#fff;padding:16px 22px;border-radius:14px;border:2px solid #ffd700;font-size:14px;line-height:1.6;box-shadow:0 0 30px rgba(255,215,0,0.4);font-family:system-ui,sans-serif;pointer-events:none;min-width:280px;}
    #top3-overlay .title{color:#ffd700;font-size:16px;font-weight:900;margin-bottom:10px;text-align:center;}
    #top3-overlay .player{margin:6px 0;padding:6px;border-radius:8px;background:rgba(255,255,255,0.05);}
    #top3-overlay .player.first{color:#ffd700;font-weight:700;font-size:15px;}
    #resume-btn{position:fixed;bottom:20px;right:20px;z-index:999999;background:#ffd700;color:#000;padding:12px 20px;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 0 20px rgba(255,215,0,0.6);}
    #resume-btn:hover{background:#ffed4e;}
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <img src="logo.png" alt="Mynvo" onerror="this.style.display='none'">
        Subway<span>Surfers</span> by <span>Mynvo</span>
      </div>
      <div class="nav-links">
        <a id="play-link">Jouer</a>
        <a onclick="openSettings();return false;">Paramètres</a>
      </div>
    </div>
  </header>
  <main>
    <div class="game-container">
      <h1>Subway Surfers – Mynvo</h1>
      <div class="game-frame">
        <div class="loading" id="loading-ui"><div class="spinner"></div><p>Chargement du jeu...</p></div>
        <button class="fs-button" id="fs-btn" title="Plein écran">Plein écran</button>
        <iframe id="game-iframe" src="./game/" allowfullscreen allow="autoplay; fullscreen *"></iframe>
      </div>
    </div>
  </main>

  <!-- FPS -->
  <div id="fps-overlay">FPS: <span id="fps-value">60</span></div>

  <!-- TOP 3 -->
  <div id="top3-overlay">
    <div class="title">TOP 3 NO COIN</div>
    <div class="player first">Mynvo – 13:27</div>
    <div class="player">Le_A – 11:51</div>
    <div class="player">.... – 0:00</div>
  </div>

  <!-- Bouton reprise -->
  <button id="resume-btn">Reprendre (après respawn)</button>

  <footer>Subway Surfers by Mynvo</footer>

  <script>
    // ============= CONFIG =============
    let config = { up: "z", down: "s", left: "q", right: "d", jump: " ", name: "Joueur" };
    try {
      const saved = localStorage.getItem("mynvoConfig");
      if (saved) config = { ...config, ...JSON.parse(saved) };
    } catch(e) {}
    function saveConfig() {
      localStorage.setItem("mynvoConfig", JSON.stringify(config));
      console.log("Config sauvegardée:", config);
    }

    let isCapturingKey = false;
    const iframe = document.getElementById('game-iframe');
    let iframeReady = false;
    let keyStates = {};
    let lastCanvas = null;

    // ============= MAPPING KEYCODES =============
    const KEY_MAP = { 'ArrowUp': 38, 'ArrowDown': 40, 'ArrowLeft': 37, 'ArrowRight': 39, ' ': 32 };

    // ============= SIMULATION D'ÉVÉNEMENTS =============
    function simulateKey(type, key, code) {
      if (!iframeReady) return;
      try {
        const doc = iframe.contentDocument;
        if (!doc) return;

        const ev = new KeyboardEvent(type, {
          key, keyCode: code, which: code, code: key === ' ' ? 'Space' : `Key${key.toUpperCase()}`, bubbles: true, cancelable: true, composed: true
        });

        [doc, iframe.contentWindow].forEach(el => el && el.dispatchEvent(ev));
        const canvas = doc.querySelector('canvas');
        if (canvas) canvas.dispatchEvent(ev);
        doc.querySelectorAll('canvas, #canvas, #unity-canvas').forEach(el => el && el.dispatchEvent(ev));
      } catch(e) {}
    }

    // ============= INPUTS ZQSD =============
    document.addEventListener('keydown', e => {
      if (isCapturingKey) return;
      const k = e.key.toLowerCase();
      const map = { [config.up]: 'ArrowUp', [config.down]: 'ArrowDown', [config.left]: 'ArrowLeft', [config.right]: 'ArrowRight', [config.jump]: ' ' };
      const target = map[k];
      if (!target || keyStates[target]) return;
      e.preventDefault(); e.stopPropagation();
      keyStates[target] = true;
      simulateKey('keydown', target, KEY_MAP[target]);
    }, true);

    document.addEventListener('keyup', e => {
      if (isCapturingKey) return;
      const k = e.key.toLowerCase();
      const map = { [config.up]: 'ArrowUp', [config.down]: 'ArrowDown', [config.left]: 'ArrowLeft', [config.right]: 'ArrowRight', [config.jump]: ' ' };
      const target = map[k];
      if (!target) return;
      keyStates[target] = false;
      simulateKey('keyup', target, KEY_MAP[target]);
    }, true);

    // ============= FPS =============
    let fpsFrames = 0, fpsLastTime = performance.now();
    function updateFPS() {
      fpsFrames++;
      const now = performance.now();
      if (now - fpsLastTime >= 1000) {
        const fps = Math.round((fpsFrames * 1000) / (now - fpsLastTime));
        document.getElementById('fps-value').textContent = fps;
        const el = document.getElementById('fps-overlay');
        const color = fps >= 55 ? '#22c55e' : fps >= 30 ? '#f59e0b' : '#ef4444';
        el.style.color = el.style.borderColor = color;
        fpsFrames = 0; fpsLastTime = now;
      }
      requestAnimationFrame(updateFPS);
    }
    updateFPS();

    // ============= FULLSCREEN =============
    document.getElementById('fs-btn').onclick = () => {
      iframe.requestFullscreen?.() || iframe.webkitRequestFullscreen?.();
    };

    // ============= FIX ULTIME : FOCUS + CLIC AUTO APRÈS RESPAWN =============
    setInterval(() => {
      try {
        const doc = iframe.contentDocument;
        if (!doc) return;
        const canvas = doc.querySelector('canvas');
        if (!canvas) return;

        canvas.setAttribute('tabindex', '1');
        canvas.focus();

        if (canvas !== lastCanvas) {
          lastCanvas = canvas;
          console.log('%c[RESPAWN DÉTECTÉ] Clic auto sur canvas!', 'color: #ff00ff; font-weight: bold;');
          setTimeout(() => {
            canvas.click();
            canvas.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
            canvas.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
          }, 600);
        }
      } catch(e) {}
    }, 500);

    // ============= BOUTON REPRENDRE =============
    document.getElementById('resume-btn').onclick = () => {
      try {
        const canvas = iframe.contentDocument?.querySelector('canvas');
        if (canvas) {
          canvas.click();
          canvas.focus();
          alert('Reprise forcée ! ZQSD activés.');
        } else {
          alert('Le jeu n\'est pas encore chargé...');
        }
      } catch(e) {
        alert('Attends que le jeu charge...');
      }
    };

    // ============= CHARGEMENT IFRAME =============
    iframe.onload = () => {
      document.getElementById('loading-ui').style.display = 'none';
      setTimeout(() => { iframeReady = true; }, 3000);
    };

    // ============= PARAMÈTRES =============
    function openSettings() {
      if (document.getElementById('mynvo-settings')) return;
      const div = document.createElement('div');
      div.id = 'mynvo-settings';
      div.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;color:#fff;padding:30px;border-radius:16px;border:4px solid #ffd700;z-index:999999;max-width:90%;box-shadow:0 0 80px #0009;';
      div.innerHTML = `
        <h2 style="color:#ffd700;text-align:center;margin-bottom:20px;">Paramètres Mynvo</h2>
        <div style="margin-bottom:20px;"><label style="display:block;margin-bottom:8px;">Pseudo</label><input id="set-name" value="${config.name}" style="width:100%;padding:10px;background:#222;border:2px solid #444;border-radius:8px;color:#fff;"></div>
        <div style="background:#1a1a1a;padding:15px;border-radius:12px;">
          <h3 style="color:#ffd700;margin-bottom:10px;">Touches</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div><label>Haut</label><div class="key-display" data-key="up">${config.up === ' ' ? 'ESPACE' : config.up.toUpperCase()}</div></div>
            <div><label>Bas</label><div class="key-display" data-key="down">${config.down.toUpperCase()}</div></div>
            <div><label>Gauche</label><div class="key-display" data-key="left">${config.left.toUpperCase()}</div></div>
            <div><label>Droite</label><div class="key-display" data-key="right">${config.right.toUpperCase()}</div></div>
            <div style="grid-column:1/-1;"><label>Saut</label><div class="key-display" data-key="jump">${config.jump === ' ' ? 'ESPACE' : config.jump.toUpperCase()}</div></div>
          </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
          <button id="close-settings" style="background:#ff4444;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Fermer</button>
          <button id="save-settings" style="background:#00ff00;color:#000;padding:10px 25px;border:none;border-radius:8px;margin-left:10px;cursor:pointer;">Enregistrer</button>
        </div>
        <p style="font-size:12px;color:#ffd700;margin-top:10px;text-align:center;">Recharge (F5) après changement</p>
      `;
      document.body.appendChild(div);

      let active = null;
      div.querySelectorAll('.key-display').forEach(el => {
        el.onclick = () => {
          if (active) active.classList.remove('active');
          active = el; el.classList.add('active'); el.textContent = '...'; isCapturingKey = true;
        };
      });

      const handler = e => {
        if (!active) return;
        e.preventDefault();
        const key = e.key;
        config[active.dataset.key] = key;
        active.textContent = key === ' ' ? 'ESPACE' : key.toUpperCase();
        active.classList.remove('active');
        active = null; isCapturingKey = false;
      };
      document.addEventListener('keydown', handler, true);

      div.querySelector('#close-settings').onclick = () => {
        document.removeEventListener('keydown', handler, true);
        isCapturingKey = false; div.remove();
      };

      div.querySelector('#save-settings').onclick = () => {
        config.name = document.getElementById('set-name').value.trim() || 'Joueur';
        saveConfig();
        document.removeEventListener('keydown', handler, true);
        isCapturingKey = false;
        alert('Sauvegardé ! Recharge (F5) pour les touches.');
        div.remove();
      };
    }

    // ============= INIT =============
    document.getElementById('play-link').onclick = () => {
      document.querySelector('.game-container').scrollIntoView({ behavior: 'smooth' });
      iframe.focus();
    };

    console.log('%c[MYNVO] ZQSD activé – Focus + clic auto après respawn', 'color: #00ff00; font-weight: bold;');
  </script>
</body>
</html>
