<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subway Surfers by Mynvo</title>
  <meta name="description" content="Subway Surfers version Mynvo avec TOP 3 et FPS">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Segoe UI,sans-serif;background:linear-gradient(135deg,#5e4fff,#8b5cf6);color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    header{background:rgba(0,0,0,0.35);backdrop-filter:blur(12px);padding:18px 40px;position:fixed;top:0;left:0;right:0;z-index:100;}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
    .logo{font-size:34px;font-weight:900;display:flex;align-items:center;gap:14px;}
    .logo img{height:50px;border-radius:50%;border:4px solid #ffd700;box-shadow:0 0 20px #ffd70044;}
    .logo span{color:#ffd700;}
    .nav-links a{color:#fff;text-decoration:none;margin-left:24px;font-weight:600;font-size:17px;transition:0.2s;cursor:pointer;}
    .nav-links a:hover{opacity:0.7;}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}
    .game-container{width:100%;max-width:1350px;background:rgba(0,0,0,0.4);backdrop-filter:blur(20px);border-radius:28px;padding:40px;box-shadow:0 25px 80px rgba(0,0,0,0.5);overflow:hidden;position:relative;}
    h1{font-size:56px;text-align:center;margin-bottom:30px;text-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .game-frame{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(0,0,0,0.6);}
    iframe{width:100%;height:720px;border:none;background:#000;display:block;}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;text-align:center;}
    .spinner{width:70px;height:70px;border:8px solid #ffffff33;border-top:8px solid #ffd700;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    footer{text-align:center;padding:25px;font-size:15px;opacity:0.85;background:rgba(0,0,0,0.2);}
    .fs-button{position:absolute;top:18px;right:18px;z-index:200;background:rgba(0,0,0,0.6);border:2px solid #ffd700;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .fs-button:hover{opacity:0.9;}
    .key-display{display:inline-block;min-width:50px;padding:10px 16px;background:#333;border:2px solid #555;border-radius:8px;text-align:center;font-weight:700;font-size:18px;cursor:pointer;transition:0.2s;}
    .key-display:hover{border-color:#ffd700;background:#444;}
    .key-display.active{border-color:#00ff00;background:#1a4d1a;animation:pulse 0.5s;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
    #fps-overlay{position:fixed;top:100px;left:20px;z-index:999999;background:rgba(0,0,0,0.85);color:#22c55e;padding:10px 18px;border-radius:12px;font-size:18px;font-weight:700;border:2px solid #22c55e;box-shadow:0 0 20px rgba(34,197,94,0.3);font-family:system-ui,sans-serif;pointer-events:none;}
    #top3-overlay{position:fixed;bottom:20px;left:20px;z-index:999999;background:rgba(0,0,0,0.9);color:#fff;padding:16px 22px;border-radius:14px;border:2px solid #ffd700;font-size:14px;line-height:1.6;box-shadow:0 0 30px rgba(255,215,0,0.4);font-family:system-ui,sans-serif;pointer-events:none;min-width:280px;}
    #top3-overlay .title{color:#ffd700;font-size:16px;font-weight:900;margin-bottom:10px;text-align:center;}
    #top3-overlay .player{margin:6px 0;padding:6px;border-radius:8px;background:rgba(255,255,255,0.05);}
    #top3-overlay .player.first{color:#ffd700;font-weight:700;font-size:15px;}
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <div class="logo">
        <img src="logo.png" alt="Mynvo" onerror="this.style.display='none'">
        Subway<span>Surfers</span> by <span>Mynvo</span>
      </div>
      <div class="nav-links">
        <a id="play-link">Jouer</a>
        <a onclick="openSettings();return false;">Param√®tres</a>
      </div>
    </div>
  </header>

  <div id="fps-overlay">üéÆ FPS: <span id="fps-value">60</span></div>
  <div id="top3-overlay">
    <div class="title">üèÜ TOP 3</div>
    <div class="player first">ü•á Mynvo ‚Äì 13:27</div>
    <div class="player">ü•à Le_A ‚Äì 11:51</div>
    <div class="player">ü•â .... ‚Äì 0:00</div>
  </div>

  <footer>Subway Surfers by Mynvo</footer>

  <script>
    // ======= CONFIG =======
    let config = { up: "z", down: "s", left: "q", right: "d", jump: " ", name: "Joueur" };
    try { const saved = localStorage.getItem("mynvoConfig"); if(saved) config={...config,...JSON.parse(saved)} } catch(e){}

    function saveConfig(){ localStorage.setItem("mynvoConfig",JSON.stringify(config)); console.log("‚úÖ Config sauvegard√©e:",config); }

    let isCapturingKey=false;
    const iframe = document.getElementById('game-iframe');
    let iframeReady = false;
    let keyStates = {};
    let currentCanvas = null;

    // ======= UTILS =======
    function getKeyCode(key){ const map={'ArrowUp':38,'ArrowDown':40,'ArrowLeft':37,'ArrowRight':39,' ':32,'z':90,'Z':90,'q':81,'Q':81,'s':83,'S':83,'d':68,'D':68,'w':87,'W':87,'a':65,'A':65}; return map[key]||0; }
    function escapeHtml(str){ if(!str && str!=='') return ''; return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

    // ======= IFRAME LOAD =======
    iframe.addEventListener('load',()=>{
      document.getElementById('loading-ui').style.display='none';
      console.log('%c[MYNVO Parent] Iframe loaded!','color:#00ff00;font-weight:bold;');
      setTimeout(()=>{
        try{
          const iframeWin = iframe.contentWindow;
          const iframeDoc = iframe.contentDocument||iframeWin.document;
          if(iframeDoc){ iframeReady=true; console.log('%c[MYNVO Parent] ‚úÖ Iframe accessible! Direct injection mode.','color:#00ff00;font-weight:bold;'); }
        } catch(err){ console.warn('%c[MYNVO Parent] ‚ö†Ô∏è Cannot access iframe (CORS). Using postMessage fallback...', 'color:#ff6b6b;', err); iframeReady=false; }
      },2000);
    });

    // ======= CANVAS WATCHER =======
    function updateCanvasReference(){
      try{
        const iframeWin=iframe.contentWindow;
        const iframeDoc=iframe.contentDocument||iframeWin.document;
        if(!iframeDoc) return;
        const canvas = iframeDoc.querySelector('canvas');
        if(canvas && canvas!==currentCanvas){
          currentCanvas=canvas;
          console.log('%c[MYNVO Parent] üéÆ Canvas d√©tect√© ou mis √† jour !','color:#00ff00;font-weight:bold;');
          canvas.focus({preventScroll:true});
          canvas.addEventListener('pointerdown',()=>canvas.focus({preventScroll:true}));
          canvas.addEventListener('mousedown',()=>canvas.focus({preventScroll:true}));
        }
      } catch(e){}
    }
    setInterval(updateCanvasReference,200);

    // ======= SIMULATE KEYS =======
    function simulateKeyInIframe(type,mappedKey,keyCode){
      if(!keyCode) return;
      try{
        if(currentCanvas){
          const ev = new KeyboardEvent(type,{keyCode:keyCode,which:keyCode,key:mappedKey,bubbles:true,cancelable:true});
          currentCanvas.dispatchEvent(ev);
        } else if(iframeReady){
          const iframeWin=iframe.contentWindow;
          const iframeDoc=iframe.contentDocument||iframeWin.document;
          iframeDoc.dispatchEvent(new KeyboardEvent(type,{keyCode:keyCode,which:keyCode,key:mappedKey,bubbles:true,cancelable:true}));
        } else {
          iframe.contentWindow.postMessage({type:keyCode?'keydown':'keyup',key:mappedKey,keyCode:keyCode},'*');
        }
      } catch(e){ console.error(e); }
    }

    // ======= KEY LISTENERS =======
    function handleKeyEvent(e, type){
      if(isCapturingKey) return;
      const keyMap = {[config.up.toLowerCase()]:{key:'ArrowUp',code:38},[config.down.toLowerCase()]:{key:'ArrowDown',code:40},[config.left.toLowerCase()]:{key:'ArrowLeft',code:37},[config.right.toLowerCase()]:{key:'ArrowRight',code:39},[config.jump]:{key:' ',code:32}};
      const mapped = keyMap[e.key.toLowerCase()];
      if(mapped){
        e.preventDefault(); e.stopImmediatePropagation();
        if(type==='keydown' && keyStates[mapped.code]) return;
        keyStates[mapped.code]=type==='keydown';
        simulateKeyInIframe(type,mapped.key,mapped.code);
      }
    }
    document.addEventListener('keydown', e=>handleKeyEvent(e,'keydown'),true);
    document.addEventListener('keyup', e=>handleKeyEvent(e,'keyup'),true);

    // ======= FPS =======
    let fpsFrames=0,fpsLastTime=performance.now();
    function updateFPS(){
      fpsFrames++;
      const now=performance.now();
      if(now-fpsLastTime>=1000){
        const fps=Math.round((fpsFrames*1000)/(now-fpsLastTime));
        const fpsEl=document.getElementById('fps-value'); fpsEl.textContent=fps;
        const el=document.getElementById('fps-overlay');
        if(fps>=55){el.style.color='#22c55e';el.style.borderColor='#22c55e';} 
        else if(fps>=30){el.style.color='#f59e0b';el.style.borderColor='#f59e0b';} 
        else{el.style.color='#ef4444';el.style.borderColor='#ef4444';}
        fpsFrames=0; fpsLastTime=now;
      }
      requestAnimationFrame(updateFPS);
    }
    updateFPS();

    // ======= FULLSCREEN =======
    document.getElementById('fs-btn').addEventListener('click',async()=>{
      try{ if(iframe.requestFullscreen) await iframe.requestFullscreen(); else if(iframe.webkitRequestFullscreen) await iframe.webkitRequestFullscreen(); }
      catch(err){ alert('Plein √©cran non support√©'); }
    });

    // ======= SETTINGS =======
    function openSettings(){
      if(document.getElementById('mynvo-settings')) return;
      const div=document.createElement('div');
      div.id='mynvo-settings';
      div.style='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;color:#fff;padding:30px 35px;border-radius:16px;border:4px solid #ffd700;z-index:999999;max-width:90%;box-shadow:0 0 80px rgba(0,0,0,0.9);';
      function getKeyDisplay(k){return k===' '?'ESPACE':k.toUpperCase();}
      div.innerHTML=`<h2 style="color:#ffd700;text-align:center;margin-bottom:20px;font-size:24px;">‚öôÔ∏è Param√®tres Mynvo</h2>
        <div style="margin-bottom:20px;"><label style="display:block;margin-bottom:8px;font-size:15px;">üìù Pseudo</label><input type="text" id="set-name" value="${escapeHtml(config.name)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;"></div>
        <div style="background:#1a1a1a;padding:20px;border-radius:12px;margin-bottom:20px;">
        <h3 style="color:#ffd700;margin-bottom:15px;font-size:18px;">üéÆ Touches de jeu</h3><p style="font-size:13px;color:#aaa;margin-bottom:15px;">Clique sur une touche puis appuie sur celle que tu veux</p>
        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:15px;">
        <div><label style="display:block;margin-bottom:8px;font-size:14px;">‚¨ÜÔ∏è Haut</label><div class="key-display" data-key="up">${getKeyDisplay(config.up)}</div></div>
        <div><label style="display:block;margin-bottom:8px;font-size:14px;">‚¨áÔ∏è Bas</label><div class="key-display" data-key="down">${getKeyDisplay(config.down)}</div></div>
        <div><label style="display:block;margin-bottom:8px;font-size:14px;">‚¨ÖÔ∏è Gauche</label><div class="key-display" data-key="left">${getKeyDisplay(config.left)}</div></div>
        <div><label style="display:block;margin-bottom:8px;font-size:14px;">‚û°Ô∏è Droite</label><div class="key-display" data-key="right">${getKeyDisplay(config.right)}</div></div>
        <div style="grid-column:1/-1;"><label style="display:block;margin-bottom:8px;font-size:14px;">üöÄ Saut</label><div class="key-display" data-key="jump">${getKeyDisplay(config.jump)}</div></div>
        </div></div>
        <div style="text-align:center;">
        <button id="close-settings" style="background:#ff4444;color:#fff;padding:12px 24px;border:none;border-radius:10px;font-size:16px;cursor:pointer;font-weight:600;">‚ùå Fermer</button>
        <button id="save-settings" style="background:#00ff00;color:#000;padding:12px 28px;border:none;border-radius:10px;font-size:16px;cursor:pointer;margin-left:12px;font-weight:700;">‚úì Enregistrer</button>
        </div>
        <p style="font-size:12px;color:#ffd700;margin-top:15px;text-align:center;font-weight:600;">‚ö†Ô∏è Recharge la page (F5) apr√®s avoir chang√© les touches</p>
      `;
      document.body.appendChild(div);
      let activeKeyElement=null;
      div.querySelectorAll('.key-display').forEach(el=>{
        el.addEventListener('click',()=>{
          if(activeKeyElement) activeKeyElement.classList.remove('active');
          activeKeyElement=el; el.classList.add('active'); el.textContent='...'; isCapturingKey=true;
        });
      });
      const captureHandler=(e)=>{
        if(!activeKeyElement) return;
        e.preventDefault(); e.stopPropagation();
        const keyName=activeKeyElement.dataset.key;
        const newKey=e.key;
        config[keyName]=newKey;
        activeKeyElement.textContent=getKeyDisplay(newKey);
        activeKeyElement.classList.remove('active'); activeKeyElement=null; isCapturingKey=false;
      };
      document.addEventListener('keydown',captureHandler,true);
      document.getElementById('close-settings').onclick=()=>{document.removeEventListener('keydown',captureHandler,true);isCapturingKey=false;div.remove();};
      document.getElementById('save-settings').onclick=()=>{
        config.name=document.getElementById('set-name').value.trim()||'Joueur'; saveConfig();
        document.removeEventListener('keydown',captureHandler,true); isCapturingKey=false;
        alert('‚úì Param√®tres sauvegard√©s !\n\n‚ö†Ô∏è IMPORTANT : Recharge la page (F5) pour que les nouvelles touches fonctionnent.'); div.remove();
      };
    }

    document.getElementById('play-link').addEventListener('click',()=>{ document.querySelector('.game-container')?.scrollIntoView({behavior:'smooth',block:'center'}); iframe.focus(); });
    console.log('%c[MYNVO Parent] Touch system initialized!','color:#58a6ff;font-weight:bold;'); console.log('%c[MYNVO Parent] Current config:','color:#ffd700;',config);
  </script>
</body>
</html>
